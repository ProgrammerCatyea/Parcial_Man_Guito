<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignaciones ‚Äì Parcial_Man_Guito</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>

<header>
    <h1>üîó Asignaciones</h1>
    <p>Relaciona miembros con proyectos activos</p>
</header>

<main>
    <section class="formulario">
        <h2>Crear Asignaci√≥n</h2>
        <form id="formAsignacion">
            <select id="miembroSelect" required>
                <option value="">Seleccionar miembro</option>
            </select>

            <select id="proyectoSelect" required>
                <option value="">Seleccionar proyecto</option>
            </select>

            <input type="text" id="rol" placeholder="Rol en el proyecto" required>
            <button type="submit">‚ûï Asignar</button>
        </form>
    </section>

    <section class="lista">
        <h2>Asignaciones Activas</h2>
        <div id="listaAsignaciones"></div>
    </section>

    <section class="reportes">
        <h2>üìú Reporte de Asignaciones Eliminadas</h2>
        <button id="descargarReporte">‚¨á Descargar Reporte</button>
    </section>
</main>

<footer>
    <a href="./index.html">üè† Volver al inicio</a>
</footer>

<script>
const baseURL = "http://127.0.0.1:8000";
const lista = document.getElementById("listaAsignaciones");
const form = document.getElementById("formAsignacion");
const miembrosSelect = document.getElementById("miembroSelect");
const proyectosSelect = document.getElementById("proyectoSelect");
const botonReporte = document.getElementById("descargarReporte");

// Cargar selects
async function cargarSelects() {
    const miembros = await fetch(`${baseURL}/miembros/`).then(r => r.json());
    const proyectos = await fetch(`${baseURL}/proyectos/`).then(r => r.json());

    miembrosSelect.innerHTML = '<option value="">Seleccionar miembro</option>' +
        miembros.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');

    proyectosSelect.innerHTML = '<option value="">Seleccionar proyecto</option>' +
        proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
}

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const nueva = {
        miembro_id: parseInt(miembrosSelect.value),
        proyecto_id: parseInt(proyectosSelect.value),
        rol: document.getElementById("rol").value
    };

    const res = await fetch(`${baseURL}/asignaciones/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(nueva)
    });

    if (res.ok) {
        alert(" Asignaci√≥n creada correctamente");
        form.reset();
        cargarAsignaciones();
    } else {
        alert(" Error al crear asignaci√≥n");
    }
});

async function cargarAsignaciones() {
    const res = await fetch(`${baseURL}/asignaciones/`);
    const data = await res.json();

    if (data.length === 0) {
        lista.innerHTML = "<p>No hay asignaciones registradas.</p>";
        return;
    }

    lista.innerHTML = `
        <table>
            <tr><th>ID</th><th>Miembro</th><th>Proyecto</th><th>Rol</th><th>Acci√≥n</th></tr>
            ${data.map(a => `
                <tr>
                    <td>${a.id}</td>
                    <td>${a.miembro?.nombre || "‚Äî"}</td>
                    <td>${a.proyecto?.nombre || "‚Äî"}</td>
                    <td>${a.rol}</td>
                    <td><button onclick="eliminarAsignacion(${a.id})">üóë Eliminar</button></td>
                </tr>`).join("")}
        </table>
    `;
}


async function eliminarAsignacion(id) {
    const confirmar = confirm("‚ö† ¬øSeguro que deseas eliminar esta asignaci√≥n?");
    if (confirmar) {
        await fetch(`${baseURL}/asignaciones/${id}`, { method: "DELETE" });
        alert("üóë Asignaci√≥n eliminada");
        cargarAsignaciones();
    }
}

botonReporte.addEventListener("click", () => {
    const link = document.createElement("a");
    link.href = `${baseURL}/asignaciones/reporte/eliminadas`;
    link.download = "reporte_asignaciones_eliminadas.txt";
    link.click();
});

cargarSelects();
cargarAsignaciones();
</script>

</body>
</html>
